---
title: 'OHIBC: CW trash layers prep'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    toc: true
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/ohibc/src/templates/ohibc_hdr1.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.path = 'Figs/',
                      echo = FALSE, message = FALSE, warning = FALSE)

library(rgdal)
library(raster)
source('~/github/ohibc/src/R/common.R')  ### an OHIBC specific version of common.R

dir_git     <- '~/github/ohibc'
dir_spatial <- file.path(dir_git, 'prep/spatial')  ### github: general buffer region shapefiles
dir_anx     <- file.path(dir_M, 'git-annex/bcprep')

### goal specific folders and info
goal     <- 'cw'
scenario <- 'v2016'
dir_goal <- file.path(dir_git, 'prep', goal, scenario)
dir_goal_anx <- file.path(dir_anx, goal, scenario)

### provenance tracking
library(provRmd); prov_setup()

### support scripts
source(file.path('~/github/ohibc/src/R/map_scores.R'))
  ### score plotting scripts
source(file.path(dir_git, 'src/R/rast_tools.R')) 
  ### raster plotting and analyzing scripts

### set up the default BC projection to be BC Albers
p4s_bcalb <- c('bcalb' = '+init=epsg:3005')

```

#Summary

This data was used in the Clean Waters goal in OHI 2015

***

#Data Source

**Reference**: [Eriksen et al. 2014](http://journals.plos.org/plosone/article?id=10.1371/journal.pone.0111913)

**Downloaded**: December 10, 2014 directly from authors

**Native Data Resolution**:   

**Values**: Count (number/km2) and weight (g/km2) across 4 size classes  

**Time Range**: N/A

**Format**: GeoTIFF

***

# Methods

## Read in data

### Eriksen 2014 data
```{r read_plastics_data}

dir_data <- file.path(dir_M, 'git-annex/globalprep/CW_pressure_trash')

# plastics data
count_rasts_raw  <- list.files(path = file.path(dir_data, 'v2015/globalplastic_wd_cd_rasters_180'), 
                               pattern = 'count_*',  full.names = TRUE)
weight_rasts_raw <- list.files(path = file.path(dir_data, 'v2015/globalplastic_wd_cd_rasters_180'), 
                               pattern = 'weight_*', full.names = TRUE)

### LEGACY INFO?
###  There are 3 extra weight files from the data source. For sizes 2-4, there is
###  a file with a '2' at the end of it. These are the rasters
###  that work, while the other three do not. As an example:
# raster(file.path(dir_data,'v2015/globalplastic_wd_cd_rasters_180/weight_density_size2_180.tif')) 
### gives an error but
# raster(file.path(dir_data,'v2015/globalplastic_wd_cd_rasters_180/weight_density_size2_180_2.tif')) 
### works! These are the ones we will use, along with weight size 1 which appears to work
```

### van Sebille 2015 data

from: van Sebille et al 2015. A global inventory of small floating plastic debris.

``` {r read_vanSebille_data}
dir_data_vs <- file.path(dir_M, 'git-annex/bcprep/_raw_data/vanSebille_plastics')

vs_files_all <- list.files(dir_data_vs, full.names = TRUE) %>%
  setNames(basename(.) %>% str_replace('.csv', ''))

# [1] "gridcell_areas"            "latitudes"                 "lebretonmodel_abundance"  
# [4] "lebretonmodel_mass"        "longitudes"                "maximenkomodel_abundance" 
# [7] "maximenkomodel_mass"       "vansebillemodel_abundance" "vansebillemodel_mass"     

vs_files <- vs_files_all[c(3, 4, 6:9)] ### select just data layers

vs_rasts <- vector('list', length = length(vs_files)) %>%
  setNames(names(vs_files))

for (i in 1:length(vs_files)) { ### i = 1
  vs_file <- vs_files[i]
  vs_fn <- names(vs_files)[i]
  
  vs_matrix <- read_csv(vs_file, col_names = FALSE) %>%
    data.matrix() %>%
    .[2:181, 1:360]
    ### it appears that row 361 is glitchy; ditch it, and ditch +90 N row as well
  rownames(vs_matrix) <- c(90:-89)
  colnames(vs_matrix) <- c(0:359)
  
  vs_rast <- raster(vs_matrix)
  extent(vs_rast) <- c(0, 360, -90, 90)
  vs_rast <- rotate(vs_rast)
  crs(vs_rast) <- CRS('+init=epsg:4326')
  
  vs_rasts[[vs_fn]] <- vs_rast
}

vs_stack <- stack(vs_rasts)
plot(vs_stack)

### rescale for comparisons
# vs_rescale <- vs_stack
# for(i in 1:nlayers(vs_stack_log)) { # i = 1
#   vs_stack_log_layer <- log(vs_stack[[i]])
#   vs_rescale[[names(vs_stack_log_layer)]] <- vs_stack_log_layer/quantile(vs_stack_log_layer, 0.9999)
# }
### still pretty different.

### Assume go with van Sebille model
writeRaster(vs_stack[['vansebillemodel_abundance']], file.path(dir_goal_anx, 'int/cw_trash_count_vansebille.tif'), overwrite = TRUE)
writeRaster(vs_stack[['vansebillemodel_mass']], file.path(dir_goal_anx, 'int/cw_trash_weight_vansebille.tif'), overwrite = TRUE)

```

## Unlog data and crop to BC regions

Data came to us logged (using base 10 log) so need to 'unlog' the data first.  While this is probably already done for global, we will re-extract here just to make sure we are accessing the raw data correctly.

```{r reproject}

rast_ct_vs <- raster(file.path(dir_goal_anx, 'int/cw_trash_count_vansebille.tif'))
rast_wt_vs <- raster(file.path(dir_goal_anx, 'int/cw_trash_weight_vansebille.tif'))

### reproject to BC Albers
rast_base_bcalb   <- raster(file.path(dir_spatial, 'raster/ohibc_rgn_raster_1000m.tif'))

wt_bcalb <- projectRaster(from = rast_wt_vs, to = rast_base_bcalb)
# values(wt_bcalb)[is.na(values(rast_base_bcalb))] <- NA

ct_bcalb <- projectRaster(from = rast_ct_vs, to = rast_base_bcalb)
# values(ct_bcalb)[is.na(values(rast_base_bcalb))] <- NA

writeRaster(wt_bcalb, file.path(dir_goal_anx, 'int/cw_trash_weight_vs.tif'), overwrite = TRUE)
writeRaster(ct_bcalb, file.path(dir_goal_anx, 'int/cw_trash_count_vs.tif'),  overwrite = TRUE)

``` 

``` {r plot plastic pollution rasters}

plot(ct_bcalb, col = cols, main = 'Count density (pieces/km2)')
plot(wt_bcalb, col = cols, main = 'Weight density (g/km2)')

```


## Log Transform
```{r log}

wt_bcalb <- raster(file.path(dir_goal_anx, 'int/cw_trash_weight_sum.tif'))
ct_bcalb <- raster(file.path(dir_goal_anx, 'int/cw_trash_count_sum.tif'))

wt_log <- calc(wt_bcalb, fun = function(x) {log(x + 1)})
ct_log <- calc(ct_bcalb, fun = function(x) {log(x + 1)})

writeRaster(wt_log, file.path(dir_goal_anx, 'int/cw_trash_weight_log_vs.tif'), overwrite = TRUE)
writeRaster(ct_log, file.path(dir_goal_anx, 'int/cw_trash_count_log_vs.tif'),  overwrite = TRUE)

plot(wt_log, col = cols, main = 'Mass density\nlog(g/km2)')
plot(ct_log, col = cols, main = 'Count density\nlog(pieces/km2)')

```

## Rescale to 99.99th quantile
```{r quantile}

wt_log <- raster(file.path(dir_goal_anx, 'int/cw_trash_weight_log.tif'))
ct_log <- raster(file.path(dir_goal_anx, 'int/cw_trash_count_log.tif'))

wt_ref <- quantile(wt_log, prob = c(0.001, 0.01, 0.1, 0.25, 0.5, 0.75, 0.9, 0.99, 0.999, 0.9999))
ct_ref <- quantile(ct_log, prob = c(0.001, 0.01, 0.1, 0.25, 0.5, 0.75, 0.9, 0.99, 0.999, 0.9999))

wt_99 <- wt_ref[10]
ct_99 <- ct_ref[10]

histogram(wt_log, main = 'Weight density (log(g/km2))')
histogram(ct_log, main = 'Count density (log(pieces/km2))')

wt_rescale <- calc(wt_log, fun = function(x) {ifelse(x > wt_99, 1, x / wt_99)}) %>%
  setNames('log_weight')
ct_rescale <- calc(ct_log, fun = function(x) {ifelse(x > ct_99, 1, x / ct_99)}) %>%
  setNames('log_count')

writeRaster(wt_rescale, file.path(dir_goal_anx, 'rescaled_layers/cw_trash_wt_rescale.tif'), overwrite = TRUE)
writeRaster(ct_rescale, file.path(dir_goal_anx, 'rescaled_layers/cw_trash_ct_rescale.tif'), overwrite = TRUE)

plot(wt_rescale, main = 'CW trash pressure layer: weight density (g/km2)',     col = cols)
plot(ct_rescale, main = 'CW trash pressure layer: count density (pieces/km2)', col = cols)

```

## Compare count vs weight
```{r compare, eval = FALSE}

# This provides some general statistics and visualizations:
compare <- stack(list(wt_rescale, ct_rescale))
pairs(compare)  

## Here is a scatter plot comparison:
plot(wt_rescale, ct_rescale, ylab="Count", xlab="Weight", maxpixels = 10000000, col = rgb(0, 0, 0, 0.2))
```

