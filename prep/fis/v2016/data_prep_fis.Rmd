---
title: 'OHIBC: data_prep_spp.Rmd'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    toc: true
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/ohibc/src/templates/ohibc_hdr1.html'
  pdf_document:
    toc: true
---

here is a setup code chunk with many of the common parameters:
``` {r setup, echo = FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.path = 'Figs/',
                      echo = FALSE, message = FALSE, warning = FALSE)

library(sp)
library(rgdal)
library(raster)
library(DT)

dir_git <- '~/github/ohibc'
dir_rgn <- file.path(dir_git, 'prep/regions')  ### github: general buffer region shapefiles
dir_anx <- file.path(dir_M, 'git-annex/bcprep')

source(file.path(dir_git, 'src/R/common.R'))  ### an OHIBC specific version of common.R

### goal specific folders and info
goal      <- 'fis'
scenario  <- 'v2016'
dir_goal  <- file.path(dir_git, 'prep', goal, scenario)
dir_goal_anx <- file.path(dir_anx, goal, scenario)

### provenance tracking
source(file.path(dir_git, 'src/R/prov.R'))   
  ### Provenance tracking functions: must source at start to initialize prov_track
prov_run_tag <- 'standard run'

### support scripts
source(file.path(dir_git, 'src/R/poly_plot_scores.R')) 
  ### score plotting scripts
source(file.path(dir_git, 'src/R/rast_tools.R')) 
  ### raster plotting and analyzing scripts
#source(file.path(dir_spp, 'R/SCRIPT_FXN.R'))
  ### goal- or script-specific support functions

### set up proj4string options: BC Albers and WGS84
p4s_wgs84 <- '+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0'
p4s_bcalb <- '+proj=aea +lat_1=50 +lat_2=58.5 +lat_0=45 +lon_0=-126 +x_0=1000000 +y_0=0 +datum=NAD83 +units=m +no_defs +ellps=GRS80 +towgs84=0,0,0'

```

fisheries reporting:
* fisheries reporting is in zones (denoted by polygons)
* some fisheries are reported by cells (4 km cells?)
  * dungeness crabs
  
  
We will work at 1 km resolution (?)
* create a raster of rgn_id at 1 km resolution
  * does this already exist?
    * yes: prep/spatial/ohibc_rgn_raster_1000m.tif
      * NOTE: the raster has some problems; e.g. Haida Gwaii is filled in
    * also 500 m raster if desired
* create a raster of fishery zones (for csv reporting)
  * at 1 km resolution
* rasterize layers for each year:
  * use nearest neighbor if reclassifying
  * use cell center (default) otherwise; this allows for gdal_rasterize
  * stack together all years of a single fishery for processing

Read in a layer to check it out and get extents etc
``` {r}
dir_dfo <- file.path(dir_anx, '_raw_data/dfo_khunter')
dir_list <- list.files(dir_dfo)
dir_list <- dir_list[file.info(file.path(dir_dfo, dir_list))$isdir] %>%
  file.path(dir_dfo, .)
#  [1] "aquaculture"                     "dungeness_crab"                  "ferry_terminals"                
#  [4] "geoduck"                         "GroundfishMgmtAreas"             "marina_pnt"                     
#  [7] "PacificFisheryMgmtAreas"         "PacificFisheryMgmtArea_SUBAREAS" "pacific_sardine"                
# [10] "salmon_enhancement_facilities"   "spot_prawn"                     

i <- 1 ### aquaculture has subfolders...

basename(dir_list[i])
# shp_list <- list.files(dir_list[i], full.names = TRUE)
shp_list <- list.files(file.path(dir_list[i], 'TENURES_PNT'), full.names = TRUE)

shp_list <- shp_list[str_detect(shp_list, '.shp$')] %>%
  str_replace('.shp', '')
shp <- list()
for (j in 1:length(shp_list)) { ### j <- 1
  shp[j] <- rgdal::readOGR(dsn   = dirname(shp_list[j]), 
                           layer = basename(shp_list[j]), 
                           stringsAsFactors = FALSE)
  print(names(shp[[j]]@data))
}

names(shp) <- shp_list

plot(shp[[1]])

d <- shp[[1]]@data

d[1, ]
shp_list
### dungeness_crab: 2001 through 2011 (2001 duplicated?)
#   ID ET_ID GRIDCELL PNT_COUNT Catch_kg Effort_hr SEASON Shape_Leng Shape_Area
# 0  0 21178  60--298         1        0         0   2001      16000    1.6e+07
  
### geoduck: 2003 through 2011
#   ID ET_ID GRIDCELL PNT_COUNT Catch_kg Effort_hr SEASON Shape_Leng Shape_Area
# 0  0 26405  75--305         3      776        12   2003      16000    1.6e+07

### pacific_sardine: 2002, 2003, 2004 (?)
#   OBJECTID OID_1 Count_ Sum_EstTon Shape_Leng Shape_Area
# 0     2893  2893      3         50      16000    1.6e+07

### spot_prawn
#   ID ET_ID GRIDCELL PNT_COUNT Catch_kg Effort_trp SEASON Shape_Leng Shape_Area
# 0  0 23574  67--258         1        0          0   2001      16000    1.6e+07

### GroundfishMgmtAreas
#   MINOR_CODE         MINOR_NAME MAJOR_CODE MAJOR_NAME GFB_MIN_CD GFB_MAJ_CD DESCR Shape_Leng Shape_Area
# 0          1 2A-EAST- SKIDEGATE          8         5D         01         08 5D-01   433586.1 4000732438

### PacificFisheryMgmtAreas
#   STATAREA HECTARES    SQ_KM SHAPE_Leng SHAPE_Area
# 0        1 109760.7 1097.607   891758.4 1097606860

### PacificFisheryMgmtArea_SUBAREAS
### NOTE: DFO_BC_PFMA_SUBAREAS_CHS_V3.shp is corrupted or invalid
### DFO_BC_PFMA_SUBAREAS_50K_V3_1:
#   MGNT_AREA SUBAREA_         NAME LABEL HECTARES    SQ_KM SHAPE_Leng SHAPE_Area
# 0         7       22 Subarea 7-22  7-22 227.6391 2.276391   16178.94    2276387

### ferry_terminals: CHRFRRTRMN_point
#                  ROUTE TELE_NUM TRMNL_LOC OPERATOR TRCKTTLFRR FERRY_ID   DATA_SRC COMMENTS VCLOHTTYR VCLTTYR
# 1 Victoria To Port Ang     <NA>      <NA>     <NA>          0        1 CHS CHARTS     <NA>         0       0
#   VCLUHTTYR VSSLSZLMT BERTHS PSNGRTTAUG PSNGRTTDEC PSNGRTTFEB OBJECTID PSNGRTTAPR PSNGRTTJAN       FYTRMTYP
# 1         0         0     NA          0          0          0        1          0          0 Ferry Terminal
#   AGENT PSNGRTTYR RI PSNGRTTJUL BUSTTLYR SRC_PROJ PSNGRTTJUN PSNGRTTMAR PSNGRTTMAY PSNGRTTNOV PSNGRTTOCT
# 1  <NA>         0  0          0        0     SSOG          0          0          0          0          0
#   PSNGRTTSEP
# 1          0

### marina_pnt: MARINA_PNT_point
#   FAX_NUMBER TREAT_AVL UNIT_TOTAL WSHRM_AVL EMAIL_ADDR WATER_AVL RV_SITE_TO MARINA_ID PEAK_PERID LOCATION CAMPSITE_T
# 1       <NA>      <NA>          0         U       <NA>         U          0       265       <NA>     <NA>          0
#   OBJECTID NAME MOORAGE_AV MAX_BOATS MARINA_SUP LUB_AVL LIVE_ABOAR LNDRY_AVL HOLD_TANKS GAS_AVL FUEL_AVL     F_CODE
# 1      265 <NA>          U         0          U       U          0         U          0       U        U BL17000000
#   PRI_PHNE_N DISPSL_AVL DIESEL_AV                  DESCRIPT DATA_SRC CONTACT COMMENTS CITY AVG_OCCUP AVG_DEPTH
# 1       <NA>          U         U Information Not Available     <NA>    <NA>     <NA> <NA>         0         0
#   ACCOM_TYPE SHOW_AVL SEC_PHNE_N SEASON RSTRT_AVL REL_IMPORT PROVINCE PWR_AVL POSTAL_COD SOURCE_PRJ STR_ADDRES TRSVLBL
# 1       <NA>        U       <NA>   <NA>         U          3     <NA>    <NA>       <NA>       NSOG       <NA>       U

### salmon_enhancement_facilities: Accommodation
# [1] "Echo Bay Guardian Trailer"


### Aquaculture:
### NOTE: not all shapefiles have the same attributes... shellfish vs finfish
### NOTE: readOGR returns warning 'Z-dimension discarded'
# Aquaculture layers:
# [1] "Finfish_Tenure_AtlanticSalmon"  31 columns
# [2] "Finfish_Tenure_ChinookSalmon"   31 columns   
# [3] "Finfish_Tenure_CohoSalmon"      31 columns   
# [4] "Finfish_Tenure_Sablefish"       31 columns    
# [5] "Finfish_Tenure_SockeyeSalmon"   31 columns
# [6] "Shellfish_Tenure_Clams"         28 columns  
# [7] "Shellfish_Tenure_Mussels"       28 columns 
# [8] "Shellfish_Tenure_Oyster"        28 columns     
# [9] "Shellfish_Tenure_Scallops"      28 columns 

### cols for finfish (atl salmon):
#   OBJECTID_1 CMPY_NUM CUL_TYPE F_CODE LAND_FILE                     LEGAL_DESC
# 0          1     1618       NC   <NA>   1409321 UF, part bed of Chancellor Cha
#            LEGAL_DE_1 LEGAL_DE_2 LEGAL_DE_3                                 LOCATION MAP_LONG
# 0 R 1, Coast District       <NA>       <NA> Hardwicke Is. Site B, Chancellor Channel  1254502
#                         NAME OBJECTID REF_NUM FINFISH_ID MAP_LAT STAT_AREA SITE_AREA TENURE_DOC
# 0 Marine Harvest Canada Inc.    23128    1581         88  502528      1340        48     112026
#   TENURE_ISS TENURE_STA        COMMONAME                               LOCATION_1 LAND_FILE_ STAT
# 0   20051231         LI Hardwicke Site B Hardwicke Is. Site B, Chancellor Channel    1409321   13
#   STAT_SUB LONGITUDE LATITUDE                        SP_LIC Shape_Leng Shape_Area
# 0       40 -125.7665  50.4147 Atlantic Salmon (Salmo salar)   1936.549   174593.6

```

``` {r child = file.path(dir_git, 'src/templates/ohibc_prov_ftr.Rmd')}
```

