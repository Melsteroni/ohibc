---
title: 'OHIBC: data_prep_hab_saltmarsh.Rmd'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    toc: true
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/ohibc/src/templates/ohibc_hdr1.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.path = 'Figs/',
                      echo = FALSE, message = FALSE, warning = FALSE)

library(raster)
library(rgdal)

source('~/github/ohibc/src/R/common.R')  ### an OHIBC specific version of common.R

dir_git     <- '~/github/ohibc'
dir_spatial <- file.path(dir_git, 'prep/spatial')  ### github: general buffer region shapefiles
dir_anx     <- file.path(dir_M, 'git-annex/bcprep')

### goal specific folders and info
goal      <- 'hab'
scenario  <- 'v2016'
dir_goal  <- file.path(dir_git, 'prep', goal, scenario)

### provenance tracking
library(provRmd); prov_setup()

### support scripts
# source(file.path('~/github/ohibc/src/R/map_scores.R'))
  ### score plotting scripts
source(file.path(dir_git, 'src/R/rast_tools.R'))
  ### raster plotting and analyzing scripts

### set up the default BC projection to be BC Albers
p4s_bcalb <- c('bcalb' = '+init=epsg:3005')

```

# Summary

create layers for HAB, CP, CS goals; calculate HAB goal

# Updates from previous assessment

***

# Data Source [NOTE: can be copied from README.md in rawdata file]
**Reference**: [citation for source data; website, literature, contact information. Version of data (if relevant). Screenshots if a series of menus had to be navigated to obtain the data.]

**Downloaded**: [date downloaded or received]

**Description**:  [e.g., surface aragonite state]

**Native data resolution**: [e.g., 1 degree, 30 m, etc.]   

**Time range**: [e.g., 1880-1899, monthly data provided for each year] 

**Format**:  [e.g. NetCDF]

***
  
# Methods

- EBSA layers as spatial extent of pressure-based models
    
``` {r create_OHI_EBSA_shp}

poly_ebsa <- readOGR(dsn = file.path(dir_anx, '_raw_data/dfo_khunter/ebsa'), 
                     layer = 'eco_bio_sig_areas', 
                     stringsAsFactors = FALSE)

ebsa_sar_2012 <- read_csv(file.path(dir_goal, 'raw/ebsa_sar_2012.csv'))

poly_ebsa@data <- poly_ebsa@data %>% 
  setNames(tolower(names(.))) %>%
  left_join(ebsa_sar_2012, by = c('id' = 'ebsa_id')) %>%
  select(ebsa_id = id, name, label, phys = physical, unique, agg = aggregation, conf) %>%
  mutate(agg  = ifelse(!is.na(unique), unique, agg),
         phys = ifelse(str_detect(label, 'Seamount'), 'seamount', phys),
         phys = ifelse(str_detect(label, 'Hydrothermal'), 'hydrothermal', phys),
         hab  = (agg %in% c('corals', 'sponges') | 
                   phys %in% c('soft bank', 'seamount', 'hydrothermal'))) %>%
  select(-unique, -label)

poly_ebsa_trim <- poly_ebsa[poly_ebsa@data$hab == TRUE, ]

# Note: Strait of Georgia sponge reefs not in main EBSA polygons; use
# sponge reef closures layer to capture these.  
poly_sg_sponges <- readOGR(dsn = file.path(dir_anx, '_raw_data/dfo_khunter',
                                           'mgmt_related_boundaries'), 
                     layer = 'Strait_of_Georgia_Sponge_Reef_Fishing_Closures', 
                     stringsAsFactors = FALSE)
poly_sg_sponges@data <- poly_sg_sponges@data %>%
  mutate(ebsa_id   = OBJECTID + 100,
         name = 'Sponge Reef',
         phys = NA,
         agg  = 'sponges',
         conf = NA,
         hab  = TRUE) %>%
  select(-OBJECTID, -Shape_Leng, -Shape_Area)

plot(poly_ebsa_trim)
plot(poly_sg_sponges, border = 'red', add = TRUE)

### Need to re-ID the polygons to prep for rbind...
poly_ebsa_trim  <- poly_ebsa_trim %>% spChFIDs(as.character(1:nrow(poly_ebsa_trim)))
poly_sg_sponges <- poly_sg_sponges %>% spChFIDs(as.character(1:nrow(poly_sg_sponges) + nrow(poly_ebsa_trim)))
poly_ebsa_hab <- rbind(poly_ebsa_trim2, poly_sg_sponges2, makeUniqueIDs = TRUE)

### save locally for next step: rasterization
writeOGR(poly_ebsa_hab, dsn = path.expand(file.path(dir_goal, 'shp')),
         layer = 'ebsa_hab', driver = 'ESRI Shapefile')

```

``` {r select_and_rasterize_ebsas}

base_rast <- raster(file.path(dir_spatial, 'ohibc_rgn_raster_500m.tif'))

gdal_rast2(src = file.path(dir_goal, 'shp', 'ebsa_hab'),
           base_rast,
           dst = file.path(dir_goal, 'tif', 'ebsa_hab.tif'),
           value = 'ebsa_id',
           override_p4s = TRUE)
           
```

***

OK, now to get all the trawl pressures layers

* Groundfish trawl (use new trawl data only?)
    * `effort` field
* Scallop trawl
    * which field? this is a confusing set of attributes
* Shrimp trawl? is this bottom trawl? http://thisfish.info/fishery/shrimp-bottom-trawl-british-columbia/
    * `sum_tow_ti`?  is that total tow time? others look like catch by spp


***

# Citation information  
[citation information: include if these data will have their own specific citation.]

***

``` {r prov_footer, results = 'asis'}
prov_wrapup()
```

