---
title: 'OHIBC: data_prep_hab_saltmarsh.Rmd'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    toc: true
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/ohibc/src/templates/ohibc_hdr1.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.path = 'Figs/',
                      echo = FALSE, message = FALSE, warning = FALSE)

library(raster)
library(rgdal)
library(rgeos)

source('~/github/ohibc/src/R/common.R')  ### an OHIBC specific version of common.R

dir_git     <- '~/github/ohibc'
dir_spatial <- file.path(dir_git, 'prep/spatial')  ### github: general buffer region shapefiles
dir_anx     <- file.path(dir_M, 'git-annex/bcprep')

### goal specific folders and info
goal      <- 'hab'
scenario  <- 'v2016'
dir_goal  <- file.path(dir_git, 'prep', goal, scenario)
dir_goal_anx <- file.path(dir_anx, goal, scenario)

### provenance tracking
library(provRmd); prov_setup()

### support scripts
source(file.path(dir_git, 'src/R/rast_tools.R')) 
  ### gdal_rast2, plotting

### set up the default BC projection to be BC Albers
p4s_bcalb <- c('bcalb' = '+init=epsg:3005')

```

# Summary

Create saltmarsh layers for HAB, CP, CS goals.  The areas calculated in this script will be used in the goal_prep script to compare area to pressure, and calculate a score.

# Updates from previous assessment

***

# Data Source [NOTE: can be copied from README.md in rawdata file]
**Reference**: [citation for source data; website, literature, contact information. Version of data (if relevant). Screenshots if a series of menus had to be navigated to obtain the data.]

**Downloaded**: [date downloaded or received]

**Description**:  [e.g., surface aragonite state]

**Native data resolution**: [e.g., 1 degree, 30 m, etc.]   

**Time range**: [e.g., 1880-1899, monthly data provided for each year] 

**Format**:  [e.g. NetCDF]

***
  
# Methods

- Salt Marsh health for status and trend
    - take CEC land cover rasters for 2005 and 2010, examine for changes in urban and agricultural land use
        - urban and agricultural land use as proxy for development in coastal zone
        - will also examine barren land
            
            > 15. Cropland: Areas dominated by intensively managed crops. These areas typically require human activities for their maintenance. This includes areas used for the production of annual crops, such as corn, soybeans, wheat, maize, vegetables, tobacco, cotton etc and also perennial grasses for grazing and woody crops such as orchards and vineyards. Crop vegetation accounts for greater than 20 percent of total vegetation.  This class does not represent natural grasslands used for light to moderate grazing.  [LCCS Code: 10037// 10025 // 21441 // 21453]
            > 16. Barren Lands: Areas characterized by bare rock, gravel, sand, silt, clay, or other earthen material, with little or no "green" vegetation present regardless of its inherent ability to support life. Generally, vegetation accounts for less than 10% of total cover.  [LCCS Code : 6001 // 6004]
            > 17. Urban and Built-up: Areas that contain at least 30 percent or greater urban constructed materials for human activities (cities, towns, transportation etc.). [LCCS Code : 5003]

    - calc coverage in each region for both years
    - determine linear trend based on the two points
    - backfill all study years based on linear model
    - WHAT IS REFERENCE POINT?
- Salt marsh extent for weighting
    - To align with seagrass extent, use CEC saltmarsh polygons

``` {r read and filter land cover rasters}

rast_saltmarsh_05_file <- file.path(dir_goal_anx, 'raster/land_cover_sm_05_100m.tif')
rast_saltmarsh_10_file <- file.path(dir_goal_anx, 'raster/land_cover_sm_10_100m.tif')

if(!file.exists(rast_saltmarsh_05_file) | !file.exists(rast_saltmarsh_10_file)) {

  rast_base <- raster(file.path(dir_spatial, 'ohibc_rgn_raster_100m.tif'))

  rast_lc_05_file <- file.path(dir_anx, '_raw_data/cec',
                               'Land_Cover_2005v2_TIFF/LandCover_2005v2',
                               'data/NA_LandCover_2005V2_25haMMU.tif')
  rast_lc_10_file <- file.path(dir_anx, '_raw_data/cec',
                               'Land_Cover_2010_TIFF/LandCover_2010',
                               'data/NA_LandCover_2010_25haMMU.tif')
  
  rast_lc_05 <- raster(rast_lc_05_file)
  rast_lc_10 <- raster(rast_lc_10_file)
  ### CRS: +proj=laea +lat_0=45 +lon_0=-100 +x_0=0 +y_0=0 +a=6370997 +b=6370997 +units=m +no_defs
  ### extents: -4418000, 4832000, -3873500, 4876500

  new_ext <- raster::extent(c('xmin' = -2250000, 'xmax' = -1550000, 'ymin' = 600000, 'ymax' = 1650000))
  rast_lc_05 <- raster::crop(rast_lc_05, new_ext)
  rast_lc_10 <- raster::crop(rast_lc_10, new_ext)
  
  values(rast_lc_05)[!values(rast_lc_05) %in% c(15, 16, 17)] <- NA
  values(rast_lc_10)[!values(rast_lc_10) %in% c(15, 16, 17)] <- NA
  
  rast_lc_05_bcalb <- raster::projectRaster(rast_lc_05, rast_base, 
                                            method = 'ngb',
                                            filename = rast_saltmarsh_05_file, 
                                            progress = 'text',
                                            overwrite = TRUE)
  rast_lc_10_bcalb <- raster::projectRaster(rast_lc_10, rast_base, 
                                            method = 'ngb',
                                            filename = rast_saltmarsh_10_file, 
                                            progress = 'text',
                                            overwrite = TRUE)
}

git_prov(rast_saltmarsh_05_file, filetype = 'output')
git_prov(rast_saltmarsh_10_file, filetype = 'output')

```

``` {r zonal stats landuse areas 2005 and 2010}

rast_lc_05_bcalb <- raster(rast_saltmarsh_05_file)
rast_lc_10_bcalb <- raster(rast_saltmarsh_10_file)
rast_1km_100m <- raster(file.path(dir_spatial, 'ohibc_inland_1km_raster_100m.tif'))
# rast_10km_100m <- raster(file.path(dir_spatial, 'ohibc_inland_10km_raster_100m.tif'))
# rast_2km_100m <- raster(file.path(dir_spatial, 'ohibc_inland_2km_raster_100m.tif'))

zonal_05_file <- file.path(dir_goal, 'int', 'zonal_stats_2005_1km.csv')
zonal_10_file <- file.path(dir_goal, 'int', 'zonal_stats_2010_1km.csv')

if(!file.exists(zonal_05_file) | !file.exists(zonal_10_file)) {
  
  ### NOTE: The crosstab function returns this warning - does it affect the
  ### outcomes, or does the function coerce the correct outcome?
      # Warning message:
      # In FUN(X[[i]], ...) : integer overflow - use sum(as.numeric(.))
  
  ptm <- proc.time()
  stats_05 <- raster::crosstab(rast_lc_05_bcalb, rast_1km_100m, useNA = TRUE, progress = 'text') %>%
    as.data.frame() %>%
    setNames(c('value', 'rgn_id', 'n_cells')) %>%
    mutate(value  = as.integer(as.character(value)),
           rgn_id = as.integer(as.character(rgn_id))) %>%
    arrange(rgn_id)
  message('Elapsed: ', (proc.time() - ptm)[3], ' sec')
  
  ptm <- proc.time()
  stats_10 <- raster::crosstab(rast_lc_10_bcalb, rast_1km_100m, useNA = TRUE, progress = 'text') %>%
    as.data.frame() %>%
    setNames(c('value', 'rgn_id', 'n_cells')) %>%
    mutate(value  = as.integer(as.character(value)),
           rgn_id = as.integer(as.character(rgn_id))) %>%
    arrange(rgn_id)
  message('Elapsed: ', (proc.time() - ptm)[3], ' sec')
  
  write_csv(stats_05, zonal_05_file)
  write_csv(stats_10, zonal_10_file)
  
} else {
  
  message('Zonal stats layers already exist: \n  ', zonal_05_file, '\n  ', zonal_10_file)
  git_prov(zonal_05_file, filetype = 'output')
  git_prov(zonal_05_file, filetype = 'output')
  
}

```

Once the landuse raster is cross-tabulated against the OHI inland raster we have the number of human landuse cells within each region.  NA values are non-human-landuse.

-----

## Calculate land use change area and total area by region

Grouping by rgn_id, the number of human landuse cells per region is simply the number of non-NA cells; the total number of cells includes both value and NA cells.

Since the cells are 1 hectare, we can easily calculate area by multiplying cell count * 0.01 km^2^ per cell.

``` {r summarize_zonal_stats, eval = TRUE}

stats_05 <- read_csv(zonal_05_file)
stats_10 <- read_csv(zonal_10_file)

rgn_names <- foreign::read.dbf(file.path(dir_spatial, 'ohibc_rgn.dbf'),
                               as.is = TRUE) %>%
  dplyr::select(rgn_id, rgn_name)

landuse_codes <- c('15' = 'cropland', '16' = 'barren', '17' = 'urban')

### Determine total cells per region (n_cells_tot) and then a cumulative
### total of cells per region
landuse_05 <- stats_05 %>%
  group_by(rgn_id) %>%
  mutate(n_tot = sum(n_cells),
         landuse = landuse_codes[as.character(value)]) %>% ### sum before filtering out NAs
  filter(!is.na(value) & !is.na(rgn_id))

landuse_10 <- stats_10 %>%
  group_by(rgn_id) %>%
  mutate(n_tot = sum(n_cells),
         landuse = landuse_codes[as.character(value)]) %>% ### sum before filtering out NAs
  filter(!is.na(value) & !is.na(rgn_id))
  
landuse_df <- landuse_05 %>%
  rename(n_cells_05 = n_cells) %>%
  left_join(landuse_10 %>%
              select(rgn_id, landuse, n_cells_10 = n_cells), 
            by = c('rgn_id', 'landuse')) %>%
  filter(landuse != 'barren') %>% ### not really helpful
  left_join(rgn_names, by = 'rgn_id') %>%
  mutate(area_per_year_km2 = (n_cells_10 - n_cells_05)/5 * 0.01) %>%
  gather(year, cells, starts_with('n_cells'))

landuse_df <- landuse_df %>%
  mutate(area_tot_km2 = n_tot * .01, ### 100 m cells = 1 hectare
         area_landuse_km2 = cells * .01,
         year = as.integer(str_replace(year, 'n_cells_', 20)),
         pct_cover = area_landuse_km2/area_tot_km2 * 100) %>%
  select(-value, -cells, -n_tot)

write_csv(landuse_df, file.path(dir_goal, 'int', 'landuse_stats_1km.csv'))

```

``` {r expand_time_series}

landuse_df <- read_csv(file.path(dir_goal, 'int', 'landuse_stats_1km.csv'))

landuse_ts <- landuse_df %>%
  rename(value_year = year) %>%
  filter(value_year == 2005) %>%
  left_join(data.frame(rgn_id = rep(1:8, times = 21), 
                       year   = rep(1995:2015, each = 8)),
            by = 'rgn_id') ### region 7 drops out - Pacific Offshore

landuse_ts <- landuse_ts %>%
  mutate(a_calc = area_landuse_km2 + area_per_year_km2 * (year - 2005),
         a_calc = ifelse(a_calc < 0, 0, a_calc),
         pct_area    = 100 * a_calc / area_tot_km2) %>%
  dplyr::select(rgn_id, rgn_name, year, landuse, area_calc_km2 = a_calc, area_tot_km2, area_per_year_km2, pct_area)

write_csv(landuse_ts, file.path(dir_goal, 'int', 'landuse_time_series_1km.csv'))

```

  
## Plot scores time series

To examine results, we plot the estimated status and trend over time.

``` {r spp_plot_scores_over_time, fig.height = 4, fig.width = 6, fig.align = 'center'}
library(ggplot2)
library(plotly)

landuse_ts <- read_csv(file.path(dir_goal, 'int', 'landuse_time_series_1km.csv'))

landuse_plot <- ggplot(landuse_ts %>%
                         filter(!is.na(year)),
                       aes(x = year, y = pct_area, group = rgn_name)) +
  ggtheme_plot +
  geom_point(aes(shape = landuse)) +
  geom_line(aes(color = rgn_name, group = landuse), size = 1, alpha = 1) +
  scale_colour_brewer(palette = 'PRGn') +
  labs(x = 'year',
       y = 'Percent of area as human landuse',
       color = 'Region')

ggplotly(landuse_plot)

```
  
# Salt marsh extent for mapping and weighting

``` {r create_bluecarbon_saltmarsh_raster, eval = TRUE}

saltmarsh_rast_file <- file.path(dir_goal_anx, 'tif/bluecarbon_saltmarsh.tif') %>%
  path.expand()

saltmarsh_poly_file <- file.path(dir_anx, '_raw_data/cec/BlueCarbon_SHP',
                                'NA_BlueCarbon/data',
                                'Saltmarsh/na_saltmarsh_areas_08FEB2015.shp') %>%
  path.expand()

if(!file.exists(saltmarsh_rast_file)) {
  
  base_rast <- raster(rast_base_file)
  
  ### contains polys for all of North America.  Read it in; filter to just Canada BC; reproject
  saltmarsh_poly <- readOGR(dsn = path.expand(dirname(saltmarsh_poly_file)),
                           layer = basename(saltmarsh_poly_file) %>% str_replace('.shp$', ''))
  saltmarsh_poly_bc <- saltmarsh_poly[saltmarsh_poly@data$STATE_ABB == 'CA-BC', ]
  saltmarsh_poly_bcalb <- spTransform(saltmarsh_poly_bc, base_rast@crs)
  writeOGR(saltmarsh_poly_bcalb, 
           dsn    = path.expand(file.path(dir_goal_anx, 'shp')),
           layer  = 'bluecarbon_saltmarsh',
           driver = 'ESRI Shapefile')
  
  gdal_rast2(src = file.path(dir_goal_anx, 'shp/bluecarbon_saltmarsh.shp'), 
             base_rast, saltmarsh_rast_file, value = 'OBJECTID', override_p4s = TRUE)
  
} else {
  
  git_prov(saltmarsh_poly_file, filetype = 'input')
  git_prov(rast_base_file, filetype = 'input') ### base raster
  git_prov(saltmarsh_rast_file, filetype = 'output')
 
}

```

After creating blue carbon saltmarsh raster, tabulate saltmarsh area per OHIBC region. This CSV stored in github.

``` {r crosstab_saltmarsh_vs_rgns}

saltmarsh_rgns_file <- file.path(dir_goal, 'int', 'bluecarbon_saltmarsh_area.csv')

if(!file.exists(saltmarsh_rgns_file)) {
  saltmarsh_rast <- raster(file.path(dir_goal_anx, 'tif', 'bluecarbon_saltmarsh.tif')) %>%
    setNames('saltmarsh')
  
  rgn_rast <- raster(rast_base_file) %>%
    setNames('rgn_id')
  
  saltmarsh_df <- raster::crosstab(saltmarsh_rast, rgn_rast, 
                                   long = TRUE, useNA = TRUE,
                                   progress = 'text') %>%
    group_by(rgn_id) %>%
    mutate(area_tot = sum(Freq) * .01) %>%   ### get total area in region
    filter(!is.na(saltmarsh) & !is.na(rgn_id)) %>%
    group_by(rgn_id, area_tot) %>%
    summarize(area_saltmarsh = sum(Freq) * .01) ### get just saltmarsh area in region
  
  
  write_csv(saltmarsh_df, saltmarsh_rgns_file)

} else {
  
  git_prov(file.path(dir_goal_anx, 'tif', 'bluecarbon_saltmarsh.tif'), filetype = 'input')
  git_prov(rast_base_file, filetype = 'input')
  git_prov(saltmarsh_rgns_file, filetype = 'output')
}

```

***

# Citation information  
[citation information: include if these data will have their own specific citation.]

***

``` {r prov_footer, results = 'asis'}
prov_wrapup()
```

