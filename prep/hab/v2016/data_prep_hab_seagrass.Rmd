---
title: 'OHIBC: data_prep_hab_seagrass.Rmd'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    toc: true
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/ohibc/src/templates/ohibc_hdr1.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.path = 'Figs/',
                      echo = FALSE, message = FALSE, warning = FALSE)

library(raster)
library(rgdal)
library(rgeos)

source('~/github/ohibc/src/R/common.R')  ### an OHIBC specific version of common.R

dir_git     <- '~/github/ohibc'
dir_spatial <- file.path(dir_git, 'prep/spatial')  ### github: general buffer region shapefiles
dir_anx     <- file.path(dir_M, 'git-annex/bcprep')

### goal specific folders and info
goal      <- 'hab'
scenario  <- 'v2016'
dir_goal  <- file.path(dir_git, 'prep', goal, scenario)
dir_goal_anx <- file.path(dir_anx, goal, scenario)

### provenance tracking
library(provRmd); prov_setup()

### support scripts
source(file.path(dir_git, 'src/R/rast_tools.R')) 
  ### gdal_rast2, plotting

### set up the default BC projection to be BC Albers
p4s_bcalb <- c('bcalb' = '+init=epsg:3005')

```

# Summary

Create seagrass layers for HAB, CP, CS goals.  The areas calculated in this script will be used in the goal_prep script to compare area to pressure, and calculate a score.

# Updates from previous assessment

***

# Data Source [NOTE: can be copied from README.md in rawdata file]
**Reference**: [citation for source data; website, literature, contact information. Version of data (if relevant). Screenshots if a series of menus had to be navigated to obtain the data.]

**Downloaded**: [date downloaded or received]

**Description**:  [e.g., surface aragonite state]

**Native data resolution**: [e.g., 1 degree, 30 m, etc.]   

**Time range**: [e.g., 1880-1899, monthly data provided for each year] 

**Format**:  [e.g. NetCDF]

***
  
# Methods

Sea Grass health base on pressures-based model: nutrient inputs

- Pull nutrient rasters from global fertilizer plume model
- Reproject to extents and resolution of OHIBC region 500 m raster
- Data includes years 2002 - 2013
    
``` {r read_and_clip_pressure_raster}

### Nutrient pressures layers are on Mazu here:
### Mazu:marine_threats/impact_layers_2013_redo/impact_layers/work/land_based/before_2007/raw_global_results
### Still need to get the updated versions.

dir_nutr <- file.path(dir_M, 'marine_threats/impact_layers_2013_redo/impact_layers',
                      'work/land_based/before_2007',
                      'raw_global_results')
nutr_files <- list.files(dir_nutr, pattern = '*fert*', full.names = TRUE)
new_rast_files <- file.path(dir_goal, 'tif', basename(nutr_files)) %>%
    str_replace('global', 'bc')

### cropping sped up this loop slightly, but also added time for the crop
### operation.  Leaving it out for simplicity.

rast_base <- raster(file.path(dir_spatial, 'ohibc_rgn_raster_500m.tif'))

if(any(!file.exists(new_rast_files))) {
  for(i in 1:length(nutr_files)) {
    message('Processing nutrient layer ', nutr_files[i])
    rast_nutr <- raster(nutr_files[i])
    message('... Reprojecting nutrient layer and saving to ', new_rast_files[i])
    rast_nutr_reproj <- raster::projectRaster(rast_nutr, rast_base, 
                                              filename = new_rast_files[i],
                                              overwrite = TRUE)
  }
} else {
  ### force git provenance registration
  git_prov(nutr_files, filetype = 'input')
  git_prov(new_rast_files, filetype = 'output')
}

```

Sea grass extent for mapping and weighting

- Based on seagrass biobands: eelgrass and surf grass.
- Buffer biobands by 1 km, with square end
- Rasterize buffer to 0.5 km and summarize area per region

``` {r create_saltmarsh_bioband_buffer, eval = FALSE}

# eelg_buffer_file  <- path.expand(file.path(dir_goal, 'shp', 'buffer_eelgrass.shp'))
# surfg_buffer_file <- path.expand(file.path(dir_goal, 'shp', 'buffer_surfgrass.shp'))
# 
# bioband_eelgrass_file  <- file.path(dir_anx, '_raw_data', 'bcmca',
#                                 'bcmca_eco_set_plants_complete',
#                                 'MarxanData_Plants/VascularPlants',
#                                 'BCMCA_ECO_VascPlants_Eelgrass_Bioband_MARXAN.shp')
# bioband_surfgrass_file <- file.path(dir_anx, '_raw_data', 'bcmca',
#                                 'bcmca_eco_set_plants_complete',
#                                 'MarxanData_Plants/VascularPlants',
#                                 'BCMCA_ECO_VascPlants_Surfgrass_Bioband_MARXAN.shp')
# if(!file.exists(eelg_buffer_file) | !file.exists(surfg_buffer_file)) {
# 
#   bioband_eelgrass  <- readOGR(dsn   = dirname(path.expand(bioband_eelgrass_file)), 
#                                layer = basename(bioband_eelgrass_file) %>% str_replace('.shp', ''),
#                                stringsAsFactors = FALSE)
#   bioband_surfgrass <- readOGR(dsn   = dirname(path.expand(bioband_surfgrass_file)), 
#                                layer = basename(bioband_surfgrass_file) %>% str_replace('.shp', ''),
#                                stringsAsFactors = FALSE)
#   
#   poly_eelgrass <- gBuffer(bioband_eelgrass, byid = FALSE, width = 1000, capStyle = 'FLAT') %>% 
#     SpatialPolygonsDataFrame(data.frame(1), match.ID = FALSE)
#   poly_surfgrass <- gBuffer(bioband_surfgrass, byid = FALSE, width = 1000, capStyle = 'FLAT') %>% 
#     SpatialPolygonsDataFrame(data.frame(1), match.ID = FALSE)
#   
#   writeOGR(poly_eelgrass, dsn = dirname(eelg_buffer_file), 
#            layer = basename(eelg_buffer_file) %>% str_replace('.shp', ''),
#            driver = 'ESRI Shapefile',
#            overwrite_layer = TRUE)
#   writeOGR(poly_surfgrass, dsn = dirname(surfg_buffer_file), 
#            layer = basename(surfg_buffer_file) %>% str_replace('.shp', ''),
#            driver = 'ESRI Shapefile',
#            overwrite_layer = TRUE)
# } else {
#   ### manual git_prov() calls
#   git_prov(bioband_eelgrass_file)
#   git_prov(bioband_surfgrass_file)
#   git_prov(eelg_buffer_file,  filetype = 'output')
#   git_prov(surfg_buffer_file, filetype = 'output')
# }

```

``` {r create_seagrass_bioband_buffer_raster, eval = FALSE}
# eelg_buffer_rast_file  <- path.expand(file.path(dir_goal, 'tif', 'buffer_eelgrass.tif'))
# surfg_buffer_rast_file <- path.expand(file.path(dir_goal, 'tif', 'buffer_surfgrass.tif'))
# 
# if(!file.exists(eelg_buffer_rast_file) | !file.exists(surfg_buffer_rast_file)) {
# 
# base_rast <- raster(file.path(dir_spatial, 'ohibc_rgn_raster_500m.tif'))
# 
# gdal_rast2(src = eelg_buffer_file, base_rast, eelg_buffer_rast_file)
# gdal_rast2(src = surfg_buffer_file, base_rast, surfg_buffer_rast_file)
# 
# } else {
#   ### manual git_prov() calls
#   git_prov(eelg_buffer_file, filetype = 'input')
#   git_prov(surfg_buffer_file, filetype = 'input')
#   git_prov(file.path(dir_spatial, 'ohibc_rgn_raster_500m.tif'))
#   git_prov(eelg_buffer_rast_file, filetype = 'output')
#   git_prov(surfg_buffer_rast_file, filetype = 'output')
# }
# 
# eelg_rast  <- raster(eelg_buffer_rast_file)
# surfg_rast <- raster(surfg_buffer_rast_file)
# 
# seagrass_rast <- stack(list(eelg_rast, surfg_rast * 2)) %>%
#   calc(sum, na.rm = TRUE)
# values(seagrass_rast)[values(seagrass_rast) == 0] <- NA
# 
# plot(seagrass_rast)
# 
# writeRaster(seagrass_rast, file.path(dir_goal, 'tif', 'buffer_seagrass.tif'), overwrite = TRUE)

```

``` {r create_bluecarbon_seagrass_raster, eval = TRUE}

seagrass_rast_file <- file.path(dir_goal, 'tif/bluecarbon_seagrass.tif') %>%
  path.expand()

if(!file.exists(seagrass_rast_file)) {
  
  base_rast <- raster(file.path(dir_spatial, 'ohibc_rgn_raster_500m.tif'))
  
  seagrass_poly_file <- file.path(dir_anx, '_raw_data/cec/BlueCarbon_SHP',
                                  'NA_BlueCarbon/data/Seagrass/na_seagrass_areas_Feb2015.shp') %>%
    path.expand()
  ### contains polys for all of North America.  Read it in; filter to just Canada BC; reproject
  seagrass_poly <- readOGR(dsn = path.expand(dirname(seagrass_poly_file)),
                           layer = basename(seagrass_poly_file) %>% str_replace('.shp$', ''))
  seagrass_poly_bc <- seagrass_poly[seagrass_poly@data$STATE_ABB == 'CA-BC', ]
  seagrass_poly_bcalb <- spTransform(seagrass_poly_bc, base_rast@crs)
  writeOGR(seagrass_poly_bcalb, 
           dsn = path.expand(file.path(dir_goal, 'shp')),
           layer = 'bluecarbon_seagrass',
           driver = 'ESRI Shapefile')
  
  gdal_rast2(src = file.path(dir_goal, 'shp/bluecarbon_seagrass.shp'), 
             base_rast, seagrass_rast_file, value = 'OBJECTID', override_p4s = TRUE)
  
} else {
  
  git_prov(seagrass_poly_file, filetype = 'input')
  git_prov(file.path(dir_spatial, 'ohibc_rgn_raster_500m.tif'), filetype = 'input') ### base raster
  git_prov(seagrass_rast_file, filetype = 'output')
 
}

```

After creating buffer shapefiles and rasters, tabulate seagrass area per OHIBC region

``` {r crosstab_seagrass_vs_rgns}

seagrass_rast <- raster(file.path(dir_goal, 'tif', 'bluecarbon_seagrass.tif')) %>%
  setNames('seagrass')

rgn_rast <- raster(file.path(dir_spatial, 'ohibc_rgn_raster_500m.tif')) %>%
  setNames('rgn_id')

seagrass_df <- raster::crosstab(seagrass_rast, rgn_rast, 
                                 long = TRUE, useNA = TRUE,
                                 progress = 'text') %>%
  group_by(rgn_id) %>%
  mutate(area_tot = sum(Freq) * .25) %>%   ### get total area in region
  filter(!is.na(seagrass) & !is.na(rgn_id)) %>%
  group_by(rgn_id, area_tot) %>%
  summarize(area_seagrass = sum(Freq) * .25) ### get just seagrass area in region


write_csv(seagrass_df, file.path(dir_goal, 'int', 'bluecarbon_seagrass_area.csv'))

```

# Calculate sea grass pressures and status

Sea Grass health pressures-based model: nutrient inputs

- create raster stack of all years of nutrients
- determine max nutrient load across all years and cells
- calculate pressure raster based on 0-110% of max nutrient load
    - 0.0 is zero nutrient load
    - 1.0 is 110% of max nutrient load
- mask pressure raster to seagrass presence
    
``` {r create_seagrass_nutrient_rasters}

### first, calculate the nutrient pressures
nutr_layers <- list.files(file.path(dir_goal, 'tif'), 
                          pattern = '*_fert_*', 
                          full.names = TRUE)

nutr_stack <- lapply(nutr_layers, raster) %>%
  stack()

### mask nutrient input stack to just OHIBC regions (some Puget Sound cells in there...)
rgn_rast <- raster(file.path(dir_spatial, 'ohibc_rgn_raster_500m.tif')) %>%
  setNames('rgn_id')

nutr_stack <- mask(nutr_stack, rgn_rast)

### find max value in whole EEZ and normalize to 110%
max_nutr <- maxValue(nutr_stack) %>% ### gets max for each layer
  max()                              ### finds max across all layers

nutr_prs_stack <- nutr_stack / (max_nutr * 1.10)

### now mask the pressures by seagrass presence
seagrass_rast <- raster(file.path(dir_goal, 'tif', 'bluecarbon_seagrass.tif'))

seagrass_nutr_stack <- mask(nutr_prs_stack, seagrass_rast)
names(seagrass_nutr_stack) <- names(seagrass_nutr_stack) %>%
    str_replace('bc_plumes_fert_', 'seagrass_nutr_') %>%
    str_replace('_raw', '')

outfile_names <- file.path(dir_goal, 'tif', paste0(names(seagrass_nutr_stack), '.tif'))
                           
writeRaster(seagrass_nutr_stack, 
            filename = outfile_names,
            bylayer = TRUE,
            overwrite = TRUE)


```

From seagrass pressure rasters, tabulate pressures vs seagrass cells

- number of cells at each pressure for each year

``` {r crosstab_sg_pressures}
### now crosstab seagrass nutrient pressures by regions
nutr_layer_files <- list.files(file.path(dir_goal, 'tif'), pattern = 'seagrass_nutr',
                          full.names = TRUE)

seagrass_nutr_stack <- raster::stack(nutr_layer_files)

tmp_list <- vector('list', length = nlayers(seagrass_nutr_stack))
for (i in 1:nlayers(seagrass_nutr_stack)) { # i <- 1
  nutr_year <- names(seagrass_nutr_stack[[i]]) %>%
    str_replace('seagrass_nutr_', '')
  
  nutr_rast <- seagrass_nutr_stack[[i]] %>%
    setNames('nutr_pressure')
  message('Crosstabulating ', names(nutr_rast), ' for ', nutr_year)
  nutr_df <- raster::crosstab(nutr_rast, rgn_rast,
                              digits = 4,
                              long = TRUE,
                              useNA = TRUE, 
                              progress = 'text')
  nutr_df <- nutr_df %>%
    mutate(nutr_pressure = as.numeric(as.character(nutr_pressure)), ### dammit factors!
           year = as.integer(nutr_year))
  
  tmp_list[[i]] <- nutr_df
}

seagrass_nutr_df <- bind_rows(tmp_list)

write_csv(seagrass_nutr_df, file.path(dir_goal, 'int', 'seagrass_nutr_df.csv'))

```

Summarize area-weighted mean pressure values by region and year

- sum(pressure * number of cells) / sum(number of cells)
- calculate status as (1 - mean pressure)
    
``` {r determine_seagrass_status}

seagrass_nutr_df <- read_csv(file.path(dir_goal, 'int', 'seagrass_nutr_df.csv'))

### summarize to regional means
seagrass_status_df <- seagrass_nutr_df %>%
  filter(!is.na(nutr_pressure)) %>% 
  group_by(rgn_id, year) %>%
  summarize(mean_pressure = sum(nutr_pressure * Freq) / sum(Freq),
            area_seagrass = sum(Freq) * .25) %>%
  mutate(status = 1 - mean_pressure)

write_csv(seagrass_status_df, file.path(dir_goal, 'int', 'seagrass_status_df.csv'))

DT::datatable(seagrass_status_df)

```

***

# Citation information  
[citation information: include if these data will have their own specific citation.]

***

``` {r prov_footer, results = 'asis'}
prov_wrapup()
```

