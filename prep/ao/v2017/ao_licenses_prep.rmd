---
title: 'OHIBC: Fishing licenses prep'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/ohibc/src/templates/ohibc_hdr1.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.path = 'Figs/',
                      echo = TRUE, message = FALSE, warning = FALSE)

source('~/github/ohibc/src/R/common.R')  ### an OHIBC specific version of common.R

library(lubridate)

dir_git     <- '~/github/ohibc'
dir_spatial <- file.path(dir_git, 'prep/spatial')  ### github: general buffer region shapefiles
dir_anx     <- file.path(dir_M, 'git-annex/bcprep')

### goal specific folders and info
goal     <- 'ao'
scenario <- 'v2017'
dir_goal <- file.path(dir_git, 'prep', goal, scenario)
dir_goal_anx <- file.path(dir_anx, goal, scenario)

### provenance tracking
library(provRmd); prov_setup()

### set up the default BC projection to be BC Albers
p4s_bcalb <- c('bcalb' = '+init=epsg:3005')

```

#Summary

This data is incorporated into the OHI British Columbia First Nations Resource Access and Opportunities (AO) goal.

***

#Data Source

**Reference**: 

**Downloaded**: 

**Native Data Resolution**:   

**Values**: 

**Time Range**: N/A

**Format**: CSV

***

# Methods

## Read in data

Read in DFO contamination closures from .xlsx files.

``` {r read_xlsx}

lic_clean_file <- file.path(dir_goal_anx, 'int/licenses_clean.csv')

license_file <- file.path(dir_anx, '_raw_data/fishing_license/Pacific Region Commercial Fishing Licenses En.csv')
metadata_file <- file.path(dir_anx, '_raw_data/fishing_license/Commercial License Meta Data EN (1).csv')

if(!file.exists(lic_clean_file)) {
  
  licenses_raw <- read_csv(license_file) %>%
    setNames(tolower(names(.)) %>% str_replace_all('[\\s()]+', '_'))
  
  
  for(tmp in names(licenses_raw)) {
    ### tmpname <- names(x)[1]
    licenses_raw[[tmp]] <- ifelse(is.na(licenses_raw[[tmp]]) & class(licenses_raw[[tmp]]) == 'character', 
                                  '', 
                                  licenses_raw[[tmp]])
  }
  
  metadata <- read_csv(metadata_file, skip = 54) %>%
    setNames(tolower(names(.)) %>% str_replace_all(' ', '_'))
  
  licenses_clean <- licenses_raw %>%
    left_join(metadata, by = c('licence_prefix' = 'prefix')) %>%
    mutate(lic_holder = ifelse(licence_holder_type == 'VESSEL',
                               paste('vessel', licence_holder_vessel),
                               paste(licence_holder_first_name, licence_holder_midddle_name, licence_holder_last_name)),
           lic_oper   = ifelse(licence_holder_type == 'VESSEL',
                               paste('vessel', licence_operator_vessel),
                               paste(licence_operator_first_name, licence_operator_midddle_name, licence_operator_last_name)),
           vessel_own = ifelse(licence_holder_type == 'VESSEL',
                               paste(vessel_owner_first_name, vessel_owner_midddle_name, vessel_owner_last_name),
                               NA)) %>%
    mutate(year = licence_suffix,
           fn = str_detect(tolower(prefix_description), 'aborig|northern native|northernnative')) %>%
    select(year, 
           lic_prefix = licence_prefix, 
           prefix_desc = prefix_description,
           lic_tab = licence_tab,
           fn, area,
           fishery_group, foreign_vessel,
           lic_hold_type = licence_holder_type,
           lic_hold_vessel = licence_holder_vessel,
           lic_oper_vessel = licence_operator_vessel,
           lic_holder, lic_oper, vessel_own)
  
  write_csv(licenses_clean, lic_clean_file)
} else {
  message('File exists: ', lic_clean_file)
  git_prov(c(license_file, metadata_file), 'input')
  git_prov(lic_clean_file, 'output')
}

```

### License areas

This link provides a look-up of different commercial management areas to PFMAs and PFMSAs.  This might be useful for spatializing the licenses.

http://www.pac.dfo-mpo.gc.ca/fm-gp/licence-permis/areas-secteurs-eng.html

The table in this link has been saved as a .csv in the `ao/v2017/raw` folder.


## First Nations license holders by fishery group

This bar chart shows the proportion of licenses allocated to First Nations for each fishery group.  The indicated proportion is the *maximum* for that fishery group across all years.

``` {r collate_fishery_groups}

lic_clean <- read_csv(lic_clean_file)

license_fn_yr <- lic_clean %>%
  select(year,
         prefix_desc, 
         fn,
          lic_prefix, 
          fishery_group) %>%
  mutate(fishery_group = tolower(fishery_group)) %>%
  group_by(year, fishery_group) %>%
  summarize(n_total = n(),
         n_fn = sum(fn),
         pct_fn = n_fn / n_total) %>%
  ungroup()

license_fn_yr <- license_fn_yr %>%
  group_by(fishery_group) %>%
  mutate(max_pct_fn = max(pct_fn, na.rm = TRUE)) %>%
  ungroup()

bar_by_gp <- license_fn_yr %>%
  select(max_pct_fn, fishery_group) %>%
  filter(max_pct_fn > 0) %>%
  distinct() %>%
  arrange(desc(max_pct_fn)) %>%
  mutate(fishery_group = factor(fishery_group, levels = unique(fishery_group))) %>%
  ggplot(aes(x = fishery_group, y = max_pct_fn)) +
    geom_bar(stat = 'identity') +
    theme(axis.text.x = element_text(angle = 75, hjust = 1))

print(bar_by_gp)

```

## First Nations license ownership 

This examines the total fishing license allocation to First Nations across all license types, fishery groups, and regions, by year.

``` {r total_licenses}

lic_clean <- read_csv(lic_clean_file)

license_fn_yr1 <- lic_clean %>%
  select(year,
         prefix_desc, 
         fn,
          lic_prefix,
          fishery_group) %>%
  mutate(fishery_group = tolower(fishery_group)) %>%
  group_by(year) %>%
  summarize(n_total = n(),
         n_fn = sum(fn),
         pct_fn = n_fn / n_total) %>%
  ungroup()

lic_total_plot <- ggplot(license_fn_yr1, aes(x = year, y = n_total)) +
  geom_area(fill = 'grey60', color = 'grey40', size = .25) +
  geom_area(aes(y = n_fn), fill = 'steelblue3', color = 'grey40', size = .25) +
  labs(y = 'Number of licenses')

lic_pct_plot <- ggplot(license_fn_yr1, aes(x = year, y = pct_fn)) +
  geom_line(color = 'steelblue3', size = .5) +
  labs(y = 'Percent FN licenses')

print(lic_total_plot)
print(lic_pct_plot)

```


## Spatialize licenses

Much of this code was developed for the AO Closures prep script; since there are likely idiosyncracies within the data here compared to the closures data, the code has been copied and customized rather than functionalized.

### Clean areas and subareas

Clean up area and subarea calls from the cleaned data.  No need to keep the license info at this point; can rejoin later.  Many of the descriptions are complex text such as "Area 12, Area 13, except SA 13-1 to 13-12, 13-15 to 13-17, Area 14 (except SA 14-5, 14-8, 14-15, Area 15 (except SA 15-5), Areas 16 to 29 (except SA 17-20, 23-6 and 29-5)" which must be parsed down to areas.

* Remove area-subarea notation and just keep the area level
* In many cases, areas are listed as, e.g., Areas 3 to 10.  
    * Expand these to e.g. Areas 3 4 5 6 7 8 9 10.
    * These individual area numbers are then extracted as individual observations.
* bind with rows where no "to" clause existed
* join with lookup table of PFMA area to OHIBC rgn

``` {r}

lic_area_all <- read_csv(lic_clean_file) %>%
  select(area, year) %>%
  group_by(area) %>%
  mutate(year_1 = min(year, na.rm = TRUE),
         year_n = max(year, na.rm = TRUE)) %>%
  ungroup() %>%
  select(-year) %>%
  distinct() %>%
  mutate(area = ifelse(is.na(area), 'no area designated', tolower(area)))
  
lic_area_lookup <- read_csv(file.path(dir_goal, 'raw/license_area_lookup.csv')) %>%
  mutate(lic_area = tolower(lic_area),
         desc     = tolower(desc))

# x <- lic_area_all %>%
#   filter(area %in% lic_area_lookup$lic_area) %>%
#   arrange(area)
# y <- lic_area_all %>%
#   filter(!area %in% lic_area_lookup$lic_area) %>%
#   arrange(area)
# z <- lic_area_lookup %>%
#   filter(!lic_area %in% lic_area_all$area) %>%
#   arrange(lic_area)
### All the remaining unmatched license areas (y) seem to have ended long ago,
### most before 2000, and only a couple as late as 2002 or 2003.
### Presumably these license areas are no longer valid, so don't show up
### in the license area designations.

### Because we are counting within regions rather than area-weighting, it is
### less important to worry about subareas.  Drop them for simplicity.  This
### also means not having to worry about "except" or "excludes"
lic_lookup_clean <- lic_area_lookup %>%
  select(lic_area, desc) %>%
  mutate(area_edit = desc,
         area_edit = str_replace_all(area_edit, '(?<=[0-9])[-â€”.](?=[0-9])', '~'), ### this line writes subareas as ##~##
         area_edit = str_replace_all(area_edit, '\\s+', ' '))

### step 2: expand 'to' for areas (e.g. areas 3 to 10).  
### * Identify clauses, split into 'from'/'to'
### * create a vector of from:to and convert to string.
### * str_replace the clause with the expanded vector.
### * reassemble the entire closure list string
lic_lookup_to <- lic_lookup_clean %>%
  filter(str_detect(area_edit, '[0-9] to [0-9]')) %>%
  mutate(area_split = str_split(tolower(area_edit), ',|;|and')) %>% ### divide at comma or semicolon
  unnest(area_split) %>%
  mutate(to_clause = str_extract(area_split, '[0-9]*~?[0-9]+ to [0-9]+~?[0-9]*')) %>%
  separate(to_clause, into = c('from_num', 'to_num'), sep = '[^0-9]? to ', remove = FALSE) %>%
  rowwise() %>%
  ### build vector of Area numerals, skipping sub-areas
  mutate(to_vec = ifelse(!is.na(from_num) & !str_detect(from_num, '~') & !str_detect(to_num, '~'),
                         paste(as.integer(from_num):as.integer(to_num), collapse = ', '),
                         '')) %>%
  ### build vector of Sub-Area numerals, skipping areas
  mutate(tmp_area = ifelse(!is.na(from_num) & str_detect(from_num, '~') & str_detect(to_num, '~'),
                           str_extract(from_num, '[0-9]+(?=~)'), NA),
         to_vec = ifelse(!is.na(from_num) & str_detect(from_num, '~') & str_detect(to_num, '~'),
                         paste(tmp_area, as.integer(str_extract(from_num, '(?<=~)[0-9]+')):as.integer(str_extract(to_num, '(?<=~)[0-9]+')), sep = '~', collapse = ', '),
                         '')) %>%
  ungroup() %>%
  mutate(area_split2 = ifelse(!is.na(to_clause),
                              str_replace(area_split, to_clause, to_vec),
                              area_split),
         area_split3 = str_replace_all(area_split2, '[^0-9~]+', ' '),
         area_split3 = str_trim(area_split3)) %>%
  select(-area_split, -area_split2, -to_clause, -from_num, -to_num, -to_vec) %>%
  distinct() %>%
  filter(!str_detect(area_split3, '[0-9]{4}')) %>% ### ditches four digit #s (i.e. years)
  group_by(lic_area) %>%
  summarize(desc      = first(desc),
            area_edit = paste(area_split3, collapse = ' ')) %>%
  ungroup()
  
lic_lookup_all <- lic_lookup_clean %>%
  filter(!lic_area %in% lic_lookup_to$lic_area) %>%
  mutate(area_edit = str_replace_all(area_edit, '[0-9]{4}', ''),
         area_edit = str_replace_all(area_edit, '[^0-9~]+', ' '),
         area_edit = str_trim(area_edit)) %>%
  bind_rows(lic_lookup_to) %>%
  mutate(pfma_area = str_split(area_edit, ' ')) %>%
  unnest(pfma_area) %>%
  separate(pfma_area, c('pfma', 'pfmsa'), '~') %>%
  mutate(pfma = as.integer(pfma),
         pfmsa = as.integer(pfmsa)) %>%
  select(-area_edit) %>%
  distinct()

### attach OHIBC regions by PFMA
pfma_lookup <- read_csv(file.path(dir_git, 'prep/fis/v2017/rgns/pfmsubareas_df.csv')) %>%
  select(rgn_id, pfma_id, pfmsa_id) %>%
  filter(!is.na(pfma_id) & !is.na(rgn_id)) %>%
  distinct()

lic_lookup_rgn <- lic_lookup_all %>%
  filter(is.na(pfmsa)) %>%
  inner_join(pfma_lookup, by = c('pfma' = 'pfma_id')) %>%
  bind_rows(lic_lookup_all %>%
              filter(!is.na(pfmsa)) %>%
              inner_join(pfma_lookup, by = c('pfma' = 'pfma_id', 'pfmsa' = 'pfmsa_id'))) %>%
  select(-pfmsa_id, -pfmsa) %>%
  distinct()

write_csv(lic_lookup_rgn, file.path(dir_goal, 'int/lic_lookup_rgn.csv'))


```

#### Closure areas cleaned and expanded

`r DT::datatable(lic_lookup_all)`

``` {r check_areas_vs_licenses}

lic_lookup_rgn <- read_csv(file.path(dir_goal, 'int/lic_lookup_rgn.csv')) %>%
  filter(!is.na(rgn_id))

lic_clean <- read_csv(lic_clean_file) %>%
  mutate(area = tolower(area))

lic_fn_by_rgn <- lic_clean %>%
  inner_join(lic_lookup_rgn, by = c('area' = 'lic_area')) %>%
  select(-pfma) %>%
  distinct()

x <- lic_clean %>%
  group_by(area) %>%
  mutate(year_1 = min(year, na.rm = TRUE),
            year_n = max(year, na.rm = TRUE)) %>%
  ungroup()
y <- x %>%
  filter(!year <= 1995) %>%
  filter(!str_detect(area, 'yukon|stikine|taku')) %>%
  filter(!is.na(area))
### still some areas not bound; these all end pre-2003, most pre-1999

sum_fn_by_rgn <- lic_fn_by_rgn %>%
  group_by(year, rgn_id) %>%
  summarize(n_fn = sum(fn),
            n_tot = n(),
            pct_fn = n_fn/n_tot) %>%
  filter(year >= 1995) %>% ### no First Nations licenses before 1995 on record
  filter(year < 2017)      ### incomplete current year

write_csv(sum_fn_by_rgn, file.path(dir_goal, 'int/fn_licenses_by_rgn.csv'))

```

``` {r plot_fn_by_rgn}

sum_fn_by_rgn <- read_csv(file.path(dir_goal, 'int/fn_licenses_by_rgn.csv')) %>%
  left_join(get_rgn_names(), by = 'rgn_id') %>%
  mutate(pct_fn = 100 * pct_fn)

plot_fn_by_rgn <- ggplot(sum_fn_by_rgn, aes(x = year, y = pct_fn, group = rgn_name, color = rgn_name)) +
  ggtheme_plot() +
  geom_line(size = 1.5, alpha = 0.7) +
  labs(y = 'Percent of licenses to First Nations',
       color = 'OHIBC Region')

print(plot_fn_by_rgn)

```

-----

<!--
## Fishery groups with FN licenses

``` {r inspect_fn_by_year}

license_fn_yr <- lic_clean %>%
  select(year,
         prefix_desc, 
         fn,
          lic_prefix, 
          fishery_group) %>%
  mutate(fishery_group = tolower(fishery_group)) %>%
  group_by(year, fishery_group) %>%
  summarize(n_total = n(),
         n_fn = sum(fn),
         pct_fn = n_fn / n_total) %>%
  ungroup()

license_fn_yr <- license_fn_yr %>%
  group_by(fishery_group) %>%
  mutate(max_pct_fn = max(pct_fn, na.rm = TRUE)) %>%
  ungroup()

lic_fn_yr_zero <- license_fn_yr %>%
  filter(max_pct_fn == 0) %>%
  distinct()

lic_fn_yr_gp <- license_fn_yr %>%
  filter(year < 2017) %>%
  filter(max_pct_fn > 0)

```


`r DT::datatable(lic_fn_yr_gp)`


## Fishery groups with no FN licenses indicated:

`r lic_fn_yr_zero$fishery_group %>% unique() %>% sort()`

`r DT::datatable(lic_fn_yr_zero)`
-->

<!--
## First Nations license consolidation

``` {r look into license ownership consolidation}

x <- lic_clean %>%
  filter(str_detect(tolower(fishery_group), 'atlantic salmon'))

lic_consol <- lic_clean %>%
  select(year,
          prefix_desc,
         fn,
          lic_prefix,
          fishery_group,
          lic_hold_type,
          foreign_vessel,
          lic_holder,
          lic_oper,
          vessel_own)

lic_consol_yr <- lic_consol %>%
  filter(!is.na(lic_holder)) %>%
  group_by(year, fn, lic_holder) %>%
  summarize(n_lic = n())

lic_consol1 <- lic_consol_yr %>%
  filter(n_lic > 1) %>%
  group_by(lic_holder, fn) %>%
  summarize(n_lic = sum(n_lic))

```
-->



***

``` {r prov_footer, results = 'asis'}
prov_wrapup()
```

